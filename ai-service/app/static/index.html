<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IRI Application Assistant</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: #1a1a2e;
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 18px; font-weight: 600; }
    .header .phase-badge {
      background: #16213e;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 300px;
      background: white;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      padding: 16px;
    }
    .sidebar h3 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      margin-bottom: 12px;
    }
    .field-group { margin-bottom: 16px; }
    .field-group-title {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid #eee;
    }
    .field-item {
      display: flex;
      align-items: center;
      padding: 4px 0;
      font-size: 12px;
    }
    .field-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }
    .field-dot.missing { background: #e74c3c; }
    .field-dot.unconfirmed { background: #f39c12; }
    .field-dot.confirmed { background: #27ae60; }
    .field-dot.collected { background: #3498db; }
    .field-label { color: #555; flex: 1; }
    .field-value { color: #888; font-size: 11px; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .summary-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .summary-chip {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .summary-chip.missing { background: #fde8e8; color: #e74c3c; }
    .summary-chip.unconfirmed { background: #fef3e2; color: #f39c12; }
    .summary-chip.confirmed { background: #e8f8e8; color: #27ae60; }
    .summary-chip.collected { background: #e8f0fe; color: #3498db; }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    .message {
      max-width: 75%;
      margin-bottom: 16px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.assistant {
      margin-right: auto;
    }
    .message.user {
      margin-left: auto;
    }
    .message .bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .message.assistant .bubble {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
    }
    .message.user .bubble {
      background: #1a1a2e;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .typing-indicator {
      display: none;
      padding: 12px 16px;
      margin-bottom: 16px;
      max-width: 75%;
    }
    .typing-indicator.active { display: block; }
    .typing-indicator .dots {
      display: flex;
      gap: 4px;
    }
    .typing-indicator .dot {
      width: 8px;
      height: 8px;
      background: #bbb;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); }
      40% { transform: scale(1); }
    }

    .input-area {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-area input:focus { border-color: #1a1a2e; }
    .input-area input:disabled { background: #f5f5f5; }
    .input-area button {
      padding: 12px 24px;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .input-area button:hover { background: #16213e; }
    .input-area button:disabled { background: #999; cursor: not-allowed; }

    .setup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .setup-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      width: 480px;
      max-width: 90vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .setup-card h2 { margin-bottom: 8px; }
    .setup-card p { color: #666; margin-bottom: 24px; font-size: 14px; }
    .setup-card label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
    }
    .setup-card textarea, .setup-card input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      margin-bottom: 16px;
    }
    .setup-card textarea { height: 120px; resize: vertical; }
    .setup-card .btn-row {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .setup-card button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }
    .setup-card .btn-primary { background: #1a1a2e; color: white; }
    .setup-card .btn-secondary { background: #eee; color: #333; }

    .submit-bar {
      display: none;
      padding: 12px 24px;
      background: #e8f8e8;
      border-top: 1px solid #27ae60;
      text-align: center;
    }
    .submit-bar.active { display: block; }
    .submit-bar button {
      padding: 10px 32px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .submit-bar button:hover { background: #219a52; }
  </style>
</head>
<body>

  <!-- Setup overlay -->
  <div id="setupOverlay" class="setup-overlay">
    <div class="setup-card">
      <h2>Start a Session</h2>
      <p>Load the Midland National eApp or paste custom questions.</p>

      <label>Known Data (JSON)</label>
      <textarea id="knownDataInput" placeholder='{"annuitant_first_name": "Jane", "annuitant_last_name": "Smith"}'>{
  "annuitant_first_name": "Jane",
  "annuitant_last_name": "Smith",
  "annuitant_dob": "1965-03-15",
  "annuitant_ssn": "123-45-6789",
  "annuitant_gender": "female",
  "annuitant_us_citizen": "yes"
}</textarea>

      <label>Callback URL (optional)</label>
      <input type="text" id="callbackInput" placeholder="https://eapp-api.example.com/applications/abc-123" />

      <div class="btn-row">
        <button class="btn-primary" onclick="startMidlandSession()">Load Midland eApp</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>IRI Application Assistant</h1>
    <div>
      <span class="phase-badge" id="phaseBadge">--</span>
    </div>
  </div>

  <!-- Main layout -->
  <div class="main">
    <div class="sidebar" id="sidebar">
      <h3>Field Status</h3>
      <div class="summary-bar" id="summaryBar"></div>
      <div id="fieldList"></div>
    </div>

    <div class="chat-area">
      <div class="messages" id="messages"></div>
      <div class="typing-indicator" id="typing">
        <div class="dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
      <div class="submit-bar" id="submitBar">
        <button onclick="submitSession()">Submit Application</button>
      </div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type your message..." onkeydown="if(event.key==='Enter')sendMessage()" disabled />
        <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/v1';
    let sessionId = null;
    let currentPhase = null;

    async function startMidlandSession() {
      const knownDataRaw = document.getElementById('knownDataInput').value.trim();
      const callbackUrl = document.getElementById('callbackInput').value.trim();

      let knownData = {};
      try {
        if (knownDataRaw) knownData = JSON.parse(knownDataRaw);
      } catch (e) {
        alert('Invalid JSON in known data field');
        return;
      }

      // Load Midland schema and create session
      try {
        const schemaRes = await fetch(`${API}/demo/midland-schema`);
        const questions = await schemaRes.json();

        const body = {
          questions,
          known_data: knownData,
        };
        if (callbackUrl) body.callback_url = callbackUrl;

        const res = await fetch(`${API}/sessions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const err = await res.json();
          alert(`Error creating session: ${err.detail || JSON.stringify(err)}`);
          return;
        }

        const data = await res.json();
        sessionId = data.session_id;
        currentPhase = data.phase;

        document.getElementById('setupOverlay').style.display = 'none';
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;

        updatePhase(data.phase);
        updateSummary(data.field_summary);
        updateFields(data.fields);

        if (data.greeting) {
          addMessage('assistant', data.greeting);
        }
      } catch (e) {
        alert(`Network error: ${e.message}`);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (!msg || !sessionId) return;

      input.value = '';
      addMessage('user', msg);
      setTyping(true);
      setInputEnabled(false);

      try {
        const res = await fetch(`${API}/sessions/${sessionId}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg }),
        });

        setTyping(false);

        if (!res.ok) {
          const err = await res.json();
          addMessage('assistant', `Error: ${err.detail || 'Something went wrong'}`);
          setInputEnabled(true);
          return;
        }

        const data = await res.json();
        addMessage('assistant', data.reply);
        updatePhase(data.phase);
        updateSummary(data.field_summary);

        // Refresh full field list
        await refreshFields();

        if (data.complete || data.phase === 'complete') {
          document.getElementById('submitBar').classList.add('active');
        }

        setInputEnabled(true);
      } catch (e) {
        setTyping(false);
        addMessage('assistant', `Network error: ${e.message}`);
        setInputEnabled(true);
      }
    }

    async function refreshFields() {
      if (!sessionId) return;
      try {
        const res = await fetch(`${API}/sessions/${sessionId}`);
        if (res.ok) {
          const data = await res.json();
          updateFields(data.fields);
          updateSummary(data.field_summary);
        }
      } catch (e) { /* ignore */ }
    }

    async function submitSession() {
      if (!sessionId) return;
      try {
        const res = await fetch(`${API}/sessions/${sessionId}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });
        const data = await res.json();
        addMessage('assistant', `Application ${data.status}! ${data.field_count} fields submitted.`);
        updatePhase('submitted');
        document.getElementById('submitBar').classList.remove('active');
        setInputEnabled(false);
      } catch (e) {
        addMessage('assistant', `Submit error: ${e.message}`);
      }
    }

    function addMessage(role, text) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function updatePhase(phase) {
      currentPhase = phase;
      const badge = document.getElementById('phaseBadge');
      const labels = {
        spot_check: 'Spot Check',
        collecting: 'Collecting',
        reviewing: 'Reviewing',
        complete: 'Complete',
        submitted: 'Submitted',
      };
      badge.textContent = labels[phase] || phase;
    }

    function updateSummary(summary) {
      if (!summary) return;
      const bar = document.getElementById('summaryBar');
      bar.innerHTML = '';
      const items = [
        { key: 'missing', label: 'Missing' },
        { key: 'unconfirmed', label: 'Unconfirmed' },
        { key: 'confirmed', label: 'Confirmed' },
        { key: 'collected', label: 'Collected' },
      ];
      for (const item of items) {
        const count = summary[item.key] || 0;
        if (count > 0) {
          const chip = document.createElement('span');
          chip.className = `summary-chip ${item.key}`;
          chip.textContent = `${count} ${item.label}`;
          bar.appendChild(chip);
        }
      }
    }

    function updateFields(fields) {
      if (!fields) return;
      const container = document.getElementById('fieldList');
      container.innerHTML = '';

      // Group fields by first part of field_id (before second underscore) or show flat
      for (const f of fields) {
        const item = document.createElement('div');
        item.className = 'field-item';
        item.innerHTML = `
          <div class="field-dot ${f.status}"></div>
          <span class="field-label">${escapeHtml(f.label || f.field_id)}</span>
          ${f.value ? `<span class="field-value" title="${escapeHtml(String(f.value))}">${escapeHtml(String(f.value))}</span>` : ''}
        `;
        container.appendChild(item);
      }
    }

    function setTyping(active) {
      document.getElementById('typing').classList.toggle('active', active);
    }

    function setInputEnabled(enabled) {
      document.getElementById('messageInput').disabled = !enabled;
      document.getElementById('sendBtn').disabled = !enabled;
      if (enabled) document.getElementById('messageInput').focus();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
