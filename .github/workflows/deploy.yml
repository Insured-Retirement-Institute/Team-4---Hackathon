name: Build & Deploy to App Runner

on:
  push:
    branches: [main, feature/ai-service-standalone]

env:
  AWS_REGION: us-east-1

jobs:
  deploy-backend:
    name: Deploy Backend
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: iri-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest backend/
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to App Runner
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws apprunner update-service \
            --service-arn ${{ secrets.BACKEND_APPRUNNER_ARN }} \
            --source-configuration '{
              "ImageRepository": {
                "ImageIdentifier": "'"$ECR_REGISTRY/iri-backend:$IMAGE_TAG"'",
                "ImageRepositoryType": "ECR",
                "ImageConfiguration": {
                  "Port": "5000",
                  "RuntimeEnvironmentVariables": {
                    "FLASK_ENV": "production",
                    "AWS_REGION": "us-east-1"
                  }
                }
              },
              "AutoDeploymentsEnabled": false
            }'

  deploy-ai-service:
    name: Deploy AI Service
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push AI service image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: iri-ai-service
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest ai-service/
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to App Runner
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws apprunner update-service \
            --service-arn ${{ secrets.AI_SERVICE_APPRUNNER_ARN }} \
            --source-configuration '{
              "ImageRepository": {
                "ImageIdentifier": "'"$ECR_REGISTRY/iri-ai-service:$IMAGE_TAG"'",
                "ImageRepositoryType": "ECR",
                "ImageConfiguration": {
                  "Port": "8000",
                  "RuntimeEnvironmentVariables": {
                    "HOST": "0.0.0.0",
                    "PORT": "8000",
                    "AWS_REGION": "us-east-1",
                    "BEDROCK_MODEL": "anthropic.claude-3-sonnet-20240229-v1:0",
                    "LOG_LEVEL": "info"
                  }
                }
              },
              "AutoDeploymentsEnabled": true
            }'
